# å¼‚æ­¥ç¼–ç¨‹å‘å±•å²

## ğŸ“š ç›®å½•

- [å›è°ƒå‡½æ•°æ—¶ä»£ï¼ˆES1-ES5ï¼‰](#å›è°ƒå‡½æ•°æ—¶ä»£es1-es5)
- [Promise æ—¶ä»£ï¼ˆES6ï¼‰](#promiseæ—¶ä»£es6)
- [Generator æ—¶ä»£ï¼ˆES6ï¼‰](#generatoræ—¶ä»£es6)
- [async/await æ—¶ä»£ï¼ˆES2017ï¼‰](#asyncawaitæ—¶ä»£es2017)
- [ç°ä»£å¼‚æ­¥æ¨¡å¼ï¼ˆES2018+ï¼‰](#ç°ä»£å¼‚æ­¥æ¨¡å¼es2018)
- [å®é™…åº”ç”¨åœºæ™¯](#å®é™…åº”ç”¨åœºæ™¯)
- [æ€§èƒ½å¯¹æ¯”ä¸æœ€ä½³å®è·µ](#æ€§èƒ½å¯¹æ¯”ä¸æœ€ä½³å®è·µ)
- [é¢è¯•å¸¸è€ƒé—®é¢˜](#é¢è¯•å¸¸è€ƒé—®é¢˜)

---

## å›è°ƒå‡½æ•°æ—¶ä»£ï¼ˆES1-ES5ï¼‰

### ğŸ“ å›è°ƒå‡½æ•°ç‰¹æ€§

| ç‰¹æ€§               | è¯­æ³•                     | ç¤ºä¾‹                                          | ç”¨é€”      |
| ------------------ | ------------------------ | --------------------------------------------- | --------- |
| **å›è°ƒå‡½æ•°**       | `function(callback)`     | `setTimeout(callback, 1000)`                  | å¼‚æ­¥æ‰§è¡Œ  |
| **äº‹ä»¶ç›‘å¬**       | `addEventListener`       | `element.addEventListener('click', callback)` | äº‹ä»¶å¤„ç†  |
| **XMLHttpRequest** | `xhr.onreadystatechange` | `xhr.onreadystatechange = callback`           | AJAX è¯·æ±‚ |

### ğŸ”§ è¯¦ç»†è¯´æ˜

**å›è°ƒå‡½æ•° - åŸºç¡€å¼‚æ­¥**

> **ğŸ¯ è§£å†³çš„é—®é¢˜**ï¼šè§£å†³äº† JavaScript å•çº¿ç¨‹æ‰§è¡Œçš„é—®é¢˜ï¼Œè®©ç¨‹åºèƒ½å¤Ÿå¤„ç†å¼‚æ­¥æ“ä½œã€‚

```javascript
// åŸºç¡€å›è°ƒå‡½æ•°
function fetchData(callback) {
  setTimeout(() => {
    const data = { name: "å¼ ä¸‰", age: 25 };
    callback(data);
  }, 1000);
}

fetchData((data) => {
  console.log("è·å–åˆ°æ•°æ®:", data);
});

// å®é™…åº”ç”¨ï¼šæ–‡ä»¶è¯»å–
function readFile(filename, callback) {
  // æ¨¡æ‹Ÿæ–‡ä»¶è¯»å–
  setTimeout(() => {
    const content = `æ–‡ä»¶å†…å®¹: ${filename}`;
    callback(null, content);
  }, 500);
}

readFile("test.txt", (error, content) => {
  if (error) {
    console.error("è¯»å–å¤±è´¥:", error);
  } else {
    console.log("æ–‡ä»¶å†…å®¹:", content);
  }
});
```

**å›è°ƒåœ°ç‹±é—®é¢˜**

```javascript
// å›è°ƒåœ°ç‹±ç¤ºä¾‹
function getUserData(userId, callback) {
  // ç¬¬ä¸€æ­¥ï¼šè·å–ç”¨æˆ·ä¿¡æ¯
  getUser(userId, (user) => {
    // ç¬¬äºŒæ­¥ï¼šè·å–ç”¨æˆ·æƒé™
    getPermissions(user.id, (permissions) => {
      // ç¬¬ä¸‰æ­¥ï¼šè·å–ç”¨æˆ·è®¾ç½®
      getSettings(user.id, (settings) => {
        // ç¬¬å››æ­¥ï¼šè·å–ç”¨æˆ·åå¥½
        getPreferences(user.id, (preferences) => {
          // æœ€ç»ˆå›è°ƒ
          callback({
            user,
            permissions,
            settings,
            preferences,
          });
        });
      });
    });
  });
}

// é—®é¢˜ï¼š
// 1. ä»£ç åµŒå¥—è¿‡æ·±
// 2. é”™è¯¯å¤„ç†å›°éš¾
// 3. ä»£ç å¯è¯»æ€§å·®
// 4. éš¾ä»¥ç»´æŠ¤å’Œæµ‹è¯•
```

---

## Promise æ—¶ä»£ï¼ˆES6ï¼‰

> **ğŸ¯ è§£å†³çš„é—®é¢˜**ï¼šè§£å†³äº†å›è°ƒåœ°ç‹±çš„é—®é¢˜ï¼Œæä¾›äº†æ›´ä¼˜é›…çš„å¼‚æ­¥ç¼–ç¨‹æ–¹æ¡ˆï¼Œè®©å¼‚æ­¥ä»£ç æ›´åŠ æ¸…æ™°å’Œå¯ç»´æŠ¤ã€‚

### ğŸ“ Promise ç‰¹æ€§

| ç‰¹æ€§             | è¯­æ³•                | ç¤ºä¾‹                                    | ç”¨é€”         |
| ---------------- | ------------------- | --------------------------------------- | ------------ |
| **Promise æ„é€ ** | `new Promise()`     | `new Promise((resolve, reject) => {})`  | åˆ›å»º Promise |
| **then**         | `promise.then()`    | `promise.then(onFulfilled, onRejected)` | å¤„ç†ç»“æœ     |
| **catch**        | `promise.catch()`   | `promise.catch(onRejected)`             | é”™è¯¯å¤„ç†     |
| **finally**      | `promise.finally()` | `promise.finally(onFinally)`            | æœ€ç»ˆå¤„ç†     |
| **é™æ€æ–¹æ³•**     | `Promise.all()`     | `Promise.all([p1, p2])`                 | å¹¶å‘å¤„ç†     |
| **é™æ€æ–¹æ³•**     | `Promise.race()`    | `Promise.race([p1, p2])`                | ç«é€Ÿå¤„ç†     |

### ğŸ”§ è¯¦ç»†è¯´æ˜

**Promise åŸºç¡€ - å¼‚æ­¥å°è£…**

```javascript
// åŸºç¡€Promise
function fetchUserData(userId) {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      if (userId) {
        resolve({ id: userId, name: "å¼ ä¸‰", age: 25 });
      } else {
        reject(new Error("ç”¨æˆ·IDä¸èƒ½ä¸ºç©º"));
      }
    }, 1000);
  });
}

// ä½¿ç”¨Promise
fetchUserData(123)
  .then((user) => {
    console.log("ç”¨æˆ·ä¿¡æ¯:", user);
    return user.id;
  })
  .then((userId) => {
    console.log("ç”¨æˆ·ID:", userId);
  })
  .catch((error) => {
    console.error("é”™è¯¯:", error);
  })
  .finally(() => {
    console.log("è¯·æ±‚å®Œæˆ");
  });
```

**Promise é“¾å¼è°ƒç”¨ - è§£å†³å›è°ƒåœ°ç‹±**

```javascript
// ä½¿ç”¨Promiseé‡æ„å›è°ƒåœ°ç‹±
function getUserData(userId) {
  return getUser(userId)
    .then((user) => {
      return getPermissions(user.id).then((permissions) => ({
        user,
        permissions,
      }));
    })
    .then(({ user, permissions }) => {
      return getSettings(user.id).then((settings) => ({
        user,
        permissions,
        settings,
      }));
    })
    .then(({ user, permissions, settings }) => {
      return getPreferences(user.id).then((preferences) => ({
        user,
        permissions,
        settings,
        preferences,
      }));
    });
}

// æ›´ä¼˜é›…çš„å†™æ³•
function getUserData(userId) {
  return getUser(userId)
    .then((user) =>
      Promise.all([
        getPermissions(user.id),
        getSettings(user.id),
        getPreferences(user.id),
      ])
    )
    .then(([permissions, settings, preferences]) => ({
      user,
      permissions,
      settings,
      preferences,
    }));
}
```

**Promise é™æ€æ–¹æ³• - å¹¶å‘æ§åˆ¶**

```javascript
// Promise.all - ç­‰å¾…æ‰€æœ‰Promiseå®Œæˆ
function fetchAllData() {
  return Promise.all([fetchUserData(1), fetchUserData(2), fetchUserData(3)]);
}

fetchAllData()
  .then((users) => {
    console.log("æ‰€æœ‰ç”¨æˆ·:", users);
  })
  .catch((error) => {
    console.error("è·å–å¤±è´¥:", error);
  });

// Promise.race - ç«é€Ÿæ‰§è¡Œ
function fetchWithTimeout(url, timeout = 5000) {
  const fetchPromise = fetch(url);
  const timeoutPromise = new Promise((_, reject) => {
    setTimeout(() => reject(new Error("è¯·æ±‚è¶…æ—¶")), timeout);
  });

  return Promise.race([fetchPromise, timeoutPromise]);
}

// Promise.allSettled - ç­‰å¾…æ‰€æœ‰Promiseå®Œæˆï¼ˆæ— è®ºæˆåŠŸå¤±è´¥ï¼‰
function fetchAllDataSettled() {
  return Promise.allSettled([
    fetchUserData(1),
    fetchUserData(2),
    fetchUserData(3),
  ]);
}

fetchAllDataSettled().then((results) => {
  results.forEach((result, index) => {
    if (result.status === "fulfilled") {
      console.log(`ç”¨æˆ·${index + 1}:`, result.value);
    } else {
      console.error(`ç”¨æˆ·${index + 1}é”™è¯¯:`, result.reason);
    }
  });
});
```

---

## Generator æ—¶ä»£ï¼ˆES6ï¼‰

> **ğŸ¯ è§£å†³çš„é—®é¢˜**ï¼šè§£å†³äº† Promise é“¾å¼è°ƒç”¨çš„é—®é¢˜ï¼Œæä¾›äº†æ›´ç›´è§‚çš„å¼‚æ­¥ç¼–ç¨‹æ–¹å¼ï¼Œè®©å¼‚æ­¥ä»£ç çœ‹èµ·æ¥åƒåŒæ­¥ä»£ç ã€‚

### ğŸ“ Generator ç‰¹æ€§

| ç‰¹æ€§           | è¯­æ³•                  | ç¤ºä¾‹                       | ç”¨é€”       |
| -------------- | --------------------- | -------------------------- | ---------- |
| **function\*** | `function* name() {}` | `function* generator() {}` | ç”Ÿæˆå™¨å‡½æ•° |
| **yield**      | `yield value`         | `yield 1`                  | äº§å‡ºå€¼     |
| **yield\***    | `yield* iterable`     | `yield* [1, 2, 3]`         | å§”æ‰˜ç”Ÿæˆå™¨ |
| **next()**     | `generator.next()`    | `gen.next()`               | æ‰§è¡Œç”Ÿæˆå™¨ |
| **throw()**    | `generator.throw()`   | `gen.throw(error)`         | æŠ›å‡ºé”™è¯¯   |
| **return()**   | `generator.return()`  | `gen.return(value)`        | è¿”å›å€¼     |

### ğŸ”§ è¯¦ç»†è¯´æ˜

**Generator åŸºç¡€ - çŠ¶æ€æœº**

```javascript
// åŸºç¡€Generator
function* numberGenerator() {
  yield 1;
  yield 2;
  yield 3;
}

const gen = numberGenerator();
console.log(gen.next().value); // 1
console.log(gen.next().value); // 2
console.log(gen.next().value); // 3
console.log(gen.next().done); // true

// å®é™…åº”ç”¨ï¼šå¼‚æ­¥Generator
function* asyncGenerator() {
  try {
    const user = yield fetchUser(1);
    console.log("ç”¨æˆ·:", user);

    const posts = yield fetchPosts(user.id);
    console.log("æ–‡ç« :", posts);

    const comments = yield fetchComments(posts[0].id);
    console.log("è¯„è®º:", comments);
  } catch (error) {
    console.error("é”™è¯¯:", error);
  }
}

// æ‰§è¡Œå¼‚æ­¥Generator
function runAsyncGenerator(generator) {
  const gen = generator();

  function handle(result) {
    if (result.done) return result.value;

    return Promise.resolve(result.value)
      .then((res) => handle(gen.next(res)))
      .catch((err) => handle(gen.throw(err)));
  }

  return handle(gen.next());
}

runAsyncGenerator(asyncGenerator);
```

**Generator + Promise - å¼‚æ­¥ç¼–ç¨‹**

```javascript
// ä½¿ç”¨Generatorå¤„ç†å¼‚æ­¥æ“ä½œ
function* fetchUserData(userId) {
  try {
    const user = yield fetchUser(userId);
    const permissions = yield fetchPermissions(user.id);
    const settings = yield fetchSettings(user.id);

    return {
      user,
      permissions,
      settings,
    };
  } catch (error) {
    console.error("è·å–ç”¨æˆ·æ•°æ®å¤±è´¥:", error);
    throw error;
  }
}

// æ‰§è¡Œå™¨å‡½æ•°
function runGenerator(generator) {
  const gen = generator();

  function handle(result) {
    if (result.done) {
      return result.value;
    }

    return Promise.resolve(result.value)
      .then((value) => handle(gen.next(value)))
      .catch((error) => handle(gen.throw(error)));
  }

  return handle(gen.next());
}

// ä½¿ç”¨
runGenerator(() => fetchUserData(123))
  .then((data) => {
    console.log("ç”¨æˆ·æ•°æ®:", data);
  })
  .catch((error) => {
    console.error("é”™è¯¯:", error);
  });
```

---

## async/await æ—¶ä»£ï¼ˆES2017ï¼‰

> **ğŸ¯ è§£å†³çš„é—®é¢˜**ï¼šè§£å†³äº† Generator æ‰§è¡Œå™¨çš„é—®é¢˜ï¼Œæä¾›äº†æ›´ç®€æ´çš„å¼‚æ­¥ç¼–ç¨‹è¯­æ³•ï¼Œè®©å¼‚æ­¥ä»£ç çœ‹èµ·æ¥åƒåŒæ­¥ä»£ç ã€‚

### ğŸ“ async/await ç‰¹æ€§

| ç‰¹æ€§         | è¯­æ³•                  | ç¤ºä¾‹                                 | ç”¨é€”         |
| ------------ | --------------------- | ------------------------------------ | ------------ |
| **async**    | `async function() {}` | `async function fetchData() {}`      | å¼‚æ­¥å‡½æ•°     |
| **await**    | `await promise`       | `const result = await fetchData()`   | ç­‰å¾… Promise |
| **é”™è¯¯å¤„ç†** | `try/catch`           | `try { await fetchData() } catch {}` | é”™è¯¯å¤„ç†     |
| **å¹¶å‘æ‰§è¡Œ** | `Promise.all`         | `await Promise.all([p1, p2])`        | å¹¶å‘å¤„ç†     |

### ğŸ”§ è¯¦ç»†è¯´æ˜

**async/await åŸºç¡€ - åŒæ­¥è¯­æ³•**

```javascript
// åŸºç¡€async/await
async function fetchUserData(userId) {
  try {
    const user = await fetchUser(userId);
    const permissions = await fetchPermissions(user.id);
    const settings = await fetchSettings(user.id);

    return {
      user,
      permissions,
      settings,
    };
  } catch (error) {
    console.error("è·å–ç”¨æˆ·æ•°æ®å¤±è´¥:", error);
    throw error;
  }
}

// ä½¿ç”¨async/await
async function main() {
  try {
    const userData = await fetchUserData(123);
    console.log("ç”¨æˆ·æ•°æ®:", userData);
  } catch (error) {
    console.error("é”™è¯¯:", error);
  }
}

main();
```

**async/await å¹¶å‘ - æ€§èƒ½ä¼˜åŒ–**

```javascript
// ä¸²è¡Œæ‰§è¡Œï¼ˆæ…¢ï¼‰
async function fetchUserDataSerial(userId) {
  const user = await fetchUser(userId);
  const permissions = await fetchPermissions(user.id);
  const settings = await fetchSettings(user.id);

  return { user, permissions, settings };
}

// å¹¶å‘æ‰§è¡Œï¼ˆå¿«ï¼‰
async function fetchUserDataParallel(userId) {
  const user = await fetchUser(userId);

  // å¹¶å‘æ‰§è¡Œ
  const [permissions, settings] = await Promise.all([
    fetchPermissions(user.id),
    fetchSettings(user.id),
  ]);

  return { user, permissions, settings };
}

// å®é™…åº”ç”¨ï¼šæ‰¹é‡å¤„ç†
async function fetchMultipleUsers(userIds) {
  const promises = userIds.map((id) => fetchUserData(id));
  const users = await Promise.all(promises);
  return users;
}

// å®é™…åº”ç”¨ï¼šé”™è¯¯å¤„ç†
async function fetchUserWithFallback(userId) {
  try {
    return await fetchUser(userId);
  } catch (error) {
    console.warn("ä¸»æ•°æ®æºå¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ•°æ®æº");
    return await fetchUserFromBackup(userId);
  }
}
```

**async/await é«˜çº§ç”¨æ³•**

```javascript
// å¼‚æ­¥è¿­ä»£å™¨
async function* asyncGenerator() {
  for (let i = 0; i < 5; i++) {
    await new Promise((resolve) => setTimeout(resolve, 1000));
    yield i;
  }
}

async function consumeAsyncGenerator() {
  for await (const value of asyncGenerator()) {
    console.log(value);
  }
}

// å¼‚æ­¥å‡½æ•°è¡¨è¾¾å¼
const fetchData = async (url) => {
  const response = await fetch(url);
  return response.json();
};

// å¼‚æ­¥ç®­å¤´å‡½æ•°
const processData = async (data) => {
  const processed = await processAsync(data);
  return processed;
};

// å¼‚æ­¥ç±»æ–¹æ³•
class ApiService {
  async fetchUser(id) {
    const response = await fetch(`/api/users/${id}`);
    return response.json();
  }

  async createUser(userData) {
    const response = await fetch("/api/users", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(userData),
    });
    return response.json();
  }
}
```

---

## ç°ä»£å¼‚æ­¥æ¨¡å¼ï¼ˆES2018+ï¼‰

### ğŸ“ ç°ä»£å¼‚æ­¥ç‰¹æ€§

| ç‰¹æ€§                   | è¯­æ³•                   | ç¤ºä¾‹                                      | ç”¨é€”         |
| ---------------------- | ---------------------- | ----------------------------------------- | ------------ |
| **å¼‚æ­¥è¿­ä»£å™¨**         | `for await...of`       | `for await (const item of asyncIterable)` | å¼‚æ­¥è¿­ä»£     |
| **å¼‚æ­¥ç”Ÿæˆå™¨**         | `async function*`      | `async function* asyncGen() {}`           | å¼‚æ­¥ç”Ÿæˆå™¨   |
| **Promise.finally**    | `promise.finally()`    | `promise.finally(() => {})`               | æœ€ç»ˆå¤„ç†     |
| **Promise.allSettled** | `Promise.allSettled()` | `Promise.allSettled([p1, p2])`            | ç­‰å¾…æ‰€æœ‰å®Œæˆ |

### ğŸ”§ è¯¦ç»†è¯´æ˜

**å¼‚æ­¥è¿­ä»£å™¨ - æµå¼å¤„ç†**

> **ğŸ¯ è§£å†³çš„é—®é¢˜**ï¼šè§£å†³äº†å¤§é‡æ•°æ®æµå¼å¤„ç†çš„é—®é¢˜ï¼Œè®©å¼‚æ­¥æ•°æ®æµå¤„ç†æ›´åŠ ä¼˜é›…ã€‚

```javascript
// å¼‚æ­¥è¿­ä»£å™¨
async function* fetchUsers() {
  let page = 1;
  while (true) {
    const response = await fetch(`/api/users?page=${page}`);
    const data = await response.json();

    if (data.users.length === 0) break;

    for (const user of data.users) {
      yield user;
    }

    page++;
  }
}

// ä½¿ç”¨å¼‚æ­¥è¿­ä»£å™¨
async function processUsers() {
  for await (const user of fetchUsers()) {
    console.log("å¤„ç†ç”¨æˆ·:", user.name);
    await processUser(user);
  }
}

// å®é™…åº”ç”¨ï¼šæ–‡ä»¶æµå¤„ç†
async function* readFileLines(filename) {
  const file = await openFile(filename);

  try {
    while (!file.eof) {
      const line = await file.readLine();
      yield line;
    }
  } finally {
    await file.close();
  }
}
```

**Promise.allSettled - å®¹é”™å¤„ç†**

```javascript
// Promise.allSettled - ç­‰å¾…æ‰€æœ‰Promiseå®Œæˆ
async function fetchAllDataSafely(urls) {
  const promises = urls.map((url) => fetch(url));
  const results = await Promise.allSettled(promises);

  const successful = [];
  const failed = [];

  results.forEach((result, index) => {
    if (result.status === "fulfilled") {
      successful.push({
        url: urls[index],
        data: result.value,
      });
    } else {
      failed.push({
        url: urls[index],
        error: result.reason,
      });
    }
  });

  return { successful, failed };
}

// å®é™…åº”ç”¨ï¼šæ‰¹é‡APIè°ƒç”¨
async function fetchUserData(userIds) {
  const promises = userIds.map((id) => fetchUser(id));
  const results = await Promise.allSettled(promises);

  return results
    .filter((result) => result.status === "fulfilled")
    .map((result) => result.value);
}
```

---

## å®é™…åº”ç”¨åœºæ™¯

### 1. ç°ä»£å‰ç«¯åº”ç”¨

**React Hooks + async/await**

```javascript
import React, { useState, useEffect } from "react";

function UserProfile({ userId }) {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    async function fetchUser() {
      try {
        setLoading(true);
        const userData = await fetchUserData(userId);
        setUser(userData);
      } catch (err) {
        setError(err.message);
      } finally {
        setLoading(false);
      }
    }

    fetchUser();
  }, [userId]);

  if (loading) return <div>Loading...</div>;
  if (error) return <div>Error: {error}</div>;
  if (!user) return <div>User not found</div>;

  return (
    <div>
      <h1>{user.name}</h1>
      <p>Age: {user.age}</p>
      <p>Email: {user.email}</p>
    </div>
  );
}
```

### 2. Node.js åç«¯åº”ç”¨

**Express + async/await**

```javascript
const express = require("express");
const app = express();

// å¼‚æ­¥è·¯ç”±å¤„ç†
app.get("/api/users/:id", async (req, res) => {
  try {
    const user = await User.findById(req.params.id);
    if (!user) {
      return res.status(404).json({ error: "User not found" });
    }

    const permissions = await Permission.findByUserId(user.id);
    const settings = await Settings.findByUserId(user.id);

    res.json({
      user,
      permissions,
      settings,
    });
  } catch (error) {
    console.error("Error fetching user:", error);
    res.status(500).json({ error: "Internal server error" });
  }
});

// æ‰¹é‡å¤„ç†
app.post("/api/users/batch", async (req, res) => {
  try {
    const { userIds } = req.body;

    // å¹¶å‘å¤„ç†
    const users = await Promise.all(userIds.map((id) => User.findById(id)));

    // è¿‡æ»¤æ‰nullå€¼
    const validUsers = users.filter((user) => user !== null);

    res.json({ users: validUsers });
  } catch (error) {
    console.error("Error fetching users:", error);
    res.status(500).json({ error: "Internal server error" });
  }
});
```

### 3. æ•°æ®æµå¤„ç†

**æµå¼æ•°æ®å¤„ç†**

```javascript
// å¼‚æ­¥ç”Ÿæˆå™¨å¤„ç†å¤§æ•°æ®æµ
async function* processLargeDataset(dataset) {
  for (const item of dataset) {
    // æ¨¡æ‹Ÿå¼‚æ­¥å¤„ç†
    const processed = await processItem(item);
    yield processed;
  }
}

// ä½¿ç”¨æµå¼å¤„ç†
async function handleLargeDataset(dataset) {
  const results = [];

  for await (const processed of processLargeDataset(dataset)) {
    results.push(processed);

    // æ¯å¤„ç†100ä¸ªå°±ä¿å­˜ä¸€æ¬¡
    if (results.length % 100 === 0) {
      await saveResults(results);
      results.length = 0; // æ¸…ç©ºæ•°ç»„
    }
  }

  // ä¿å­˜å‰©ä½™ç»“æœ
  if (results.length > 0) {
    await saveResults(results);
  }
}
```

---

## æ€§èƒ½å¯¹æ¯”ä¸æœ€ä½³å®è·µ

### 1. æ€§èƒ½å¯¹æ¯”

```javascript
// æ€§èƒ½æµ‹è¯•
async function performanceTest() {
  const iterations = 1000;

  // å›è°ƒå‡½æ•°æ€§èƒ½
  console.time("å›è°ƒå‡½æ•°");
  for (let i = 0; i < iterations; i++) {
    await new Promise((resolve) => {
      setTimeout(resolve, 1);
    });
  }
  console.timeEnd("å›è°ƒå‡½æ•°");

  // Promiseæ€§èƒ½
  console.time("Promise");
  for (let i = 0; i < iterations; i++) {
    await new Promise((resolve) => {
      setTimeout(resolve, 1);
    });
  }
  console.timeEnd("Promise");

  // async/awaitæ€§èƒ½
  console.time("async/await");
  for (let i = 0; i < iterations; i++) {
    await new Promise((resolve) => {
      setTimeout(resolve, 1);
    });
  }
  console.timeEnd("async/await");
}

// å…¸å‹ç»“æœï¼šasync/await â‰ˆ Promise > å›è°ƒå‡½æ•°
```

### 2. æœ€ä½³å®è·µå»ºè®®

**å¼‚æ­¥ç¼–ç¨‹æœ€ä½³å®è·µï¼š**

```javascript
// âœ… æ¨èï¼šä½¿ç”¨async/await
async function fetchData() {
  try {
    const response = await fetch("/api/data");
    return await response.json();
  } catch (error) {
    console.error("Error:", error);
    throw error;
  }
}

// âœ… æ¨èï¼šå¹¶å‘æ‰§è¡Œ
async function fetchMultipleData() {
  const [users, posts, comments] = await Promise.all([
    fetchUsers(),
    fetchPosts(),
    fetchComments(),
  ]);

  return { users, posts, comments };
}

// âœ… æ¨èï¼šé”™è¯¯å¤„ç†
async function safeFetch(url) {
  try {
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return await response.json();
  } catch (error) {
    console.error("Fetch error:", error);
    return null;
  }
}

// âœ… æ¨èï¼šè¶…æ—¶å¤„ç†
async function fetchWithTimeout(url, timeout = 5000) {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), timeout);

  try {
    const response = await fetch(url, {
      signal: controller.signal,
    });
    clearTimeout(timeoutId);
    return await response.json();
  } catch (error) {
    clearTimeout(timeoutId);
    if (error.name === "AbortError") {
      throw new Error("Request timeout");
    }
    throw error;
  }
}

// âŒ é¿å…ï¼šå›è°ƒåœ°ç‹±
// function badFetch(callback) {
//   fetchUser(1, (user) => {
//     fetchPosts(user.id, (posts) => {
//       fetchComments(posts[0].id, (comments) => {
//         callback({user, posts, comments});
//       });
//     });
//   });
// }

// âœ… å¥½çš„åšæ³•
async function goodFetch() {
  const user = await fetchUser(1);
  const posts = await fetchPosts(user.id);
  const comments = await fetchComments(posts[0].id);
  return { user, posts, comments };
}
```

---

## é¢è¯•å¸¸è€ƒé—®é¢˜

### 1. äº‹ä»¶å¾ªç¯å’Œå¼‚æ­¥æ‰§è¡Œ

```javascript
// é—®é¢˜ï¼šè§£é‡Šä»¥ä¸‹ä»£ç çš„è¾“å‡ºé¡ºåº
console.log("1");

setTimeout(() => console.log("2"), 0);

Promise.resolve().then(() => console.log("3"));

console.log("4");

// è¾“å‡ºé¡ºåºï¼š1, 4, 3, 2
// è§£é‡Šï¼š
// 1. åŒæ­¥ä»£ç å…ˆæ‰§è¡Œ
// 2. Promiseå¾®ä»»åŠ¡ä¼˜å…ˆäºsetTimeoutå®ä»»åŠ¡
// 3. äº‹ä»¶å¾ªç¯ï¼šåŒæ­¥ -> å¾®ä»»åŠ¡ -> å®ä»»åŠ¡
```

### 2. Promise çŠ¶æ€å’Œé“¾å¼è°ƒç”¨

```javascript
// é—®é¢˜ï¼šè§£é‡Šä»¥ä¸‹ä»£ç çš„è¾“å‡º
Promise.resolve(1)
  .then((x) => x + 1)
  .then((x) => Promise.resolve(x + 1))
  .then((x) => {
    throw new Error("Error");
  })
  .catch((error) => {
    console.log("Caught:", error.message);
    return 10;
  })
  .then((x) => console.log("Final:", x));

// è¾“å‡ºï¼š
// Caught: Error
// Final: 10
```

### 3. async/await é”™è¯¯å¤„ç†

```javascript
// é—®é¢˜ï¼šè§£é‡Šä»¥ä¸‹ä»£ç çš„é”™è¯¯å¤„ç†
async function test() {
  try {
    const result = await Promise.reject("Error");
    console.log("Success:", result);
  } catch (error) {
    console.log("Caught:", error);
  }
}

test();

// è¾“å‡ºï¼šCaught: Error
// è§£é‡Šï¼šasync/awaitä¸­çš„é”™è¯¯ä¼šè¢«try/catchæ•è·
```

### 4. å¹¶å‘æ§åˆ¶

```javascript
// é—®é¢˜ï¼šå®ç°ä¸€ä¸ªå¹¶å‘é™åˆ¶å‡½æ•°
async function limitConcurrency(tasks, limit = 3) {
  const results = [];
  const executing = [];

  for (const task of tasks) {
    const promise = task().then((result) => {
      executing.splice(executing.indexOf(promise), 1);
      return result;
    });

    results.push(promise);
    executing.push(promise);

    if (executing.length >= limit) {
      await Promise.race(executing);
    }
  }

  return Promise.all(results);
}

// ä½¿ç”¨ç¤ºä¾‹
const tasks = Array.from(
  { length: 10 },
  (_, i) => () => fetch(`/api/data/${i}`)
);

limitConcurrency(tasks, 3).then((results) => console.log("All done:", results));
```

---

## ğŸ“‹ æ€»ç»“

### è®°å¿†æŠ€å·§

1. **æ—¶é—´çº¿è®°å¿†**ï¼šå›è°ƒå‡½æ•° â†’ Promise â†’ Generator â†’ async/await
2. **é—®é¢˜è®°å¿†**ï¼šæ¯ä¸ªé˜¶æ®µè§£å†³çš„ä¸»è¦é—®é¢˜
3. **è¯­æ³•è®°å¿†**ï¼šå…³é”®è¯­æ³•å’Œç”¨æ³•
4. **æ€§èƒ½è®°å¿†**ï¼šå„ç§æ–¹å¼çš„æ€§èƒ½ç‰¹ç‚¹
5. **åº”ç”¨è®°å¿†**ï¼šå®é™…åº”ç”¨åœºæ™¯

### ä½¿ç”¨å»ºè®®

1. **ä¼˜å…ˆä½¿ç”¨ async/await**ï¼šæ›´ç®€æ´ã€æ›´æ˜“è¯»
2. **æ³¨æ„é”™è¯¯å¤„ç†**ï¼šä½¿ç”¨ try/catch
3. **åˆç†ä½¿ç”¨å¹¶å‘**ï¼šPromise.all æé«˜æ€§èƒ½
4. **é¿å…å›è°ƒåœ°ç‹±**ï¼šä½¿ç”¨ç°ä»£å¼‚æ­¥è¯­æ³•
5. **æ³¨æ„æ€§èƒ½å½±å“**ï¼šé€‰æ‹©åˆé€‚çš„æ–¹å¼
