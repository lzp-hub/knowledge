# 模块化与工程化（3–5 年工程师·高频精编）

## 1) CommonJS、ESModule、UMD、IIFE 的区别与迁移策略 🔥

**一句话回答**
CJS 运行时同步 `require`，ESM 编译期静态 `import` 可 tree-shaking；UMD 兼容浏览器与 Node；IIFE 早期打包产物。

**要点**

- CJS：`require/module.exports`，同步、动态。
- ESM：`import/export`，静态、可摇树优化。
- UMD：兼容多环境（AMD/CJS/全局）。
- 迁移：优先 ESM，配合 `type: "module"`、`exports` 字段。

**详细回答**
ESM 的静态依赖让 bundler 能做 **tree-shaking / sideEffects** 优化；Node 已支持 ESM（`.mjs` 或 `package.json: { type: "module" }`），配合 `exports` 指定不同入口（`import`/`require`）。老包仍是 CJS，可通过 **双入口发布**（dual package）。

**扩展/对比**

- **package.json 字段**：`main`（CJS），`module`（ESM，非标准但被打包器使用），`exports`（现代通用，子路径导出）。
- **陷阱**：混用 CJS/ESM 的默认导出差异；ESM 顶层 `await`、循环依赖时序。

---

## 2) package.json 中 dependencies / devDependencies / peer / optional 的语义 🔥

**一句话回答**
`dependencies` 运行时必需；`devDependencies` 仅开发/构建期；`peerDependencies` 声明与宿主共享版本；`optionalDependencies` 可失败不阻塞安装。

**要点**

- peer：库告知“需由使用者安装同版本”。
- optional：缺失不致命（如可选特性）。
- engines / os / cpu：安装条件限制。

**详细回答**
组件库常用 `peerDependencies`（如 React 插件），避免重复装多份 React。业务仓库避免滥用 `peer`，会增加安装复杂度。

**扩展/对比**

- **锁文件**：npm `package-lock.json`、yarn `yarn.lock`、pnpm `pnpm-lock.yaml`。
- **pnpm 优势**：内容寻址 + 硬链接，去重极佳。

---

## 3) npm / yarn / pnpm 对比与依赖提升（hoisting）机制 🔥

**一句话回答**
pnpm 通过内容寻址与硬链接显著节省空间；hoisting 影响 `node_modules` 结构与解析性能。

**要点**

- npm/yarn：平铺依赖（Hoist）。
- pnpm：严格、去重好，能避免“幽灵依赖”。
- workspace：多包协作、统一脚本与版本管理。

**详细回答**
Monorepo 建议 `pnpm workspace`（或 Nx/Turbo 驱动），可 **局部安装/构建**、缓存任务结果，提升 CI 速度。

**扩展/对比**

- **幽灵依赖**：子包未声明却可用（由于 hoist），pnpm 默认能避免。
- **选择建议**：中大型团队 → pnpm + Turborepo/Nx。

---

## 4) Tree-shaking 生效的前提与 sideEffects 字段 🔥

**一句话回答**
需要 ESM 静态分析 + 没有副作用；通过 `sideEffects: false` 或精确标注启用更激进摇树。

**要点**

- 仅 ESM 能可靠摇树。
- `sideEffects`：标注无副作用文件或通配。
- 死代码消除依赖压缩器（Terser/SWC）。

**详细回答**
若库在模块顶层执行副作用（如注册全局），标记错误会被错误移除。对 CSS/Polyfill 等应在 `sideEffects` 中保持白名单：`["*.css", "./polyfills/*.js"]`。

**扩展/对比**

- **CommonJS 难摇树**：动态 `require`。
- **编译链影响**：Babel 插件可能破坏静态性（如动态插桩）。

---

## 5) 代码分割（Code Splitting）与动态加载策略 🔥

**一句话回答**
按路由/组件/功能分块，`import()` 动态加载，配合预加载/预取提升感知速度。

**要点**

- 路由分块：大路由首选。
- 组件懒加载：`React.lazy()` / `Suspense`。
- 资源提示：`<link rel="preload/prefetch">`。

**详细回答**
分块要平衡：**过细 = 请求过多**；**过粗 = 首屏过大**。关键路径资源用 `preload`，非关键下一步交互用 `prefetch`（会被浏览器降级/延后）。

**扩展/对比**

- **Next.js**：自动路由分割 + `next/dynamic`。
- **缓存友好**：稳定的分块边界 + 长缓存 + 内容哈希。

---

## 6) 产物指纹与缓存策略（contenthash / immutable） 🔥

**一句话回答**
使用 `contenthash` 命名并开启长缓存（`Cache-Control: max-age=31536000, immutable`），变更即换名，缓存自然失效。

**要点**

- 文件名含 hash。
- HTML 不缓存或短缓存。
- CDN + 回源校验。

**详细回答**
HTML 指向最新 chunk 名称；静态资源走 CDN，命中率高。对第三方 chunk 拆分（如 `react`）可最大化复用。

**扩展/对比**

- **Source Map**：仅在受控环境保留（`hidden-source-map`），线上异常结合 Sentry。
- **分环境缓存**：灰度/回滚更安全。

---

## 7) Vite / Webpack / Rollup / Rspack 的适用场景与性能差异 🔥

**一句话回答**
Vite（ESBuild dev + Rollup build）开发快；Webpack 生态全能；Rollup 适合库打包；Rspack（Rust）在大型项目构建更快。

**要点**

- Dev：Vite HMR 极快，按需编译。
- Build：Rollup 产物更“干净”。
- 迁移：Webpack → Rspack 通常成本较低。

**详细回答**
生产构建比对：Rollup/webpack/rspack 各有插件生态；现代项目越来越多使用 **Rspack** 提速构建与 minify（SWC）。

**扩展/对比**

- **SWC/Esbuild**：转译/压缩替代 Babel/Terser，速度数量级提升。
- **兼容性**：Babel 生态更全，混用方案常见。

---

## 8) Monorepo 设计：Turborepo / Nx / pnpm workspace 🔥

**一句话回答**
Monorepo 统一依赖与版本，配合任务编排与缓存（Remote Cache）极大提升 CI/本地效率。

**要点**

- 任务图（graph）与 **仅改动包** 执行。
- Remote Cache：跨机器复用构建产物。
- 版本发布：changeset / lerna / semver 规范。

**详细回答**
抽公共包（UI、utils、hooks），应用共享 ESLint/TS 配置。通过 **Changesets** 自动汇总变更、产出 Changelog 与版本提升建议。

**扩展/对比**

- **Trunk-based** 更适合 Monorepo。
- **风险**：耦合升高，需门禁（lint/test/build 必须绿）。

---

## 9) CI/CD 最佳实践：缓存、并行、灰度、回滚 🔥

**一句话回答**
CI 缓存依赖与构建；CD 分阶段发布（灰度/蓝绿/金丝雀），保留快速回滚路径与产物追踪（Build ID）。

**要点**

- 依赖缓存（包管理器缓存 + 构建缓存）。
- 构建矩阵并行。
- 环境配置：.env 注入与密钥管理（Vault/Actions Secrets）。

**详细回答**
流水线：Lint → Test → Build → Scan（依赖漏洞/SCA）→ Upload Artifacts → Deploy（分环境）→ E2E 验证 → Promote。配合 **健康检查 / 自动回滚** 降低风险。

**扩展/对比**

- **前端回滚**：切流/回退 CDN 版本、回滚 HTML 指针。
- **Infra**：容器镜像 + IaC（Terraform）让环境可复现。

---

## 10) 质量门禁：ESLint/Prettier/TypeScript/Commitlint/Husky 🔥

**一句话回答**
通过统一规约与 Git 钩子，保证提交即质量门槛，减少线上缺陷。

**要点**

- ESLint + Prettier：风格/可维护。
- TS 严格模式：`noImplicitAny` 等。
- commitlint + conventional commits：自动生成 Changelog。

**详细回答**
使用 **lint-staged** 仅检查改动文件；在 CI 再全量检查，避免遗漏。TS 类型做“边界约束”（API 入参/出参类型）。

**扩展/对比**

- **型安 vs 速度**：严格 TS 初期成本高，但长线收益显著。
- **与测试金字塔呼应**：类型检查 ≈ 零成本单测。

---

## 11) Source Map、错误监控与版本追踪 🔥

**一句话回答**
产物上传 Source Map 至监控平台，前端异常可反解定位源码与版本。

**要点**

- `hidden-source-map`：不暴露公网。
- 版本绑定：`release` / build id。
- 错误采集：全局捕获、资源加载失败、Promise Rejection。

**详细回答**
集成 Sentry/ARMS，自定义 `beforeSend` 脱敏；对 **跨源脚本** 设置 `crossorigin` 与服务器 `Access-Control-Allow-Origin` 以解栈。

**扩展/对比**

- **RUM & Web Vitals**：LCP/CLS/INP 上报 + 性能预算（budget）。
- **前后端关联**：trace id 串联链路。

---

## 12) 模块联邦（Module Federation）与微前端基建 🔥

**一句话回答**
运行时远程加载模块，实现多应用共享与独立交付，但要权衡版本、性能与隔离。

**要点**

- Host/Remote、共享依赖（单例 React）。
- 路由/样式/权限对齐。
- Runtime vs Build-time（MF vs 构建时包）。

**详细回答**
适合多团队并行；公共依赖采用 **单例共享**；配合 **约束层**（协议与类型定义）降低耦合。路由与设计系统保持一致性。

**扩展/对比**

- **qiankun**（iframe/sandbox） vs **MF**（模块粒度）。
- **RSC 时代**：很多场景可用 **Server Components + 分仓** 简化。

---

## 13) 环境与配置管理：多环境 .env、特性开关（Feature Flag） 🔥

**一句话回答**
用 `.env.[env]` 区分环境，敏感配置走密钥管理；功能灰度用 Feature Flag 可随时开关。

**要点**

- .env 注入（构建期 vs 运行时）。
- Feature Flag（远程配置/百分比灰度）。
- 配置分层：公共/环境/本地私有。

**详细回答**
Next.js/前端 SPA 通常是 **构建期注入**，若需运行时配置可在部署时下发 `window.__RUNTIME_CONFIG__`。Flag 与埋点联动，评估新特性指标。

**扩展/对比**

- **密钥**：禁止进仓；使用 Secrets/参数存储（SSM）。
- **布控**：Flag 结合金丝雀发布，快速止血。

---

## 14) 产物体积治理：Bundle 分析与性能预算 🔥

**一句话回答**
使用分析工具（如 rollup/webpack-bundle-analyzer）找大块、拆依赖、设预算报警。

**要点**

- 拆第三方：lodash 按需、dayjs 替 moment。
- 按路由分块 + 组件懒加载。
- 图片/字体/CDN/HTTP 缓存协同。

**详细回答**
设 **体积阈值**（如单页 ≤ 200KB gz），CI 失败即阻断；与 **Web Vitals** 联动，持续降低 LCP/INP。

**扩展/对比**

- **Polyfill 策略**：按需注入（`core-js` targets / Polyfill.io）。
- **Edge/SSR**：把计算前置到服务端/边缘。

---

## 15) 发布与版本策略：SemVer、Changelog、回滚流程 🔥

**一句话回答**
遵循 SemVer（major/minor/patch），自动生成 Changelog，并准备一键回滚与静态资源历史档案。

**要点**

- conventional commits → 变更语义化。
- Changesets/Lerna 管理多包版本。
- 回滚策略：切换 HTML 指针或 CDN 版本别名。

**详细回答**
构建产物带 **build id / git sha**，配合监控面板定位具体发布。出问题时 **先回滚再排查**，缩短 MTTR。

**扩展/对比**

- **灰度策略**：按流量/人群/地区分批。
- **法务/合规**：三方依赖 license 审核（OSS Review）。

---
